name: Deploy to Server

on:
  push:
    branches:
      - cicd-deploy
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Test SSH connection
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        command_timeout: 2m
        script: |
          echo "ğŸ”— æµ‹è¯•SSHè¿æ¥..."
          echo "æœåŠ¡å™¨ä¿¡æ¯: $(uname -a)"
          echo "Dockerç‰ˆæœ¬: $(docker --version)"
          echo "Docker Composeç‰ˆæœ¬: $(docker compose --version)"
          echo "Gitç‰ˆæœ¬: $(git --version)"

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        command_timeout: 30m
        script: |
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd ${{ secrets.PROJECT_PATH }}

          # ç¡®ä¿éƒ¨ç½²è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x github-deploy.sh

          # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œéƒ¨ç½²è„šæœ¬..."
          ./github-deploy.sh

    - name: Verify deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        command_timeout: 5m
        script: |
          cd ${{ secrets.PROJECT_PATH }}

          echo "ğŸ” éªŒè¯éƒ¨ç½²ç»“æœ..."

          # æ£€æŸ¥Dockerå®¹å™¨çŠ¶æ€
          echo "Docker å®¹å™¨çŠ¶æ€ï¼š"
          docker compose -f docker-compose.prod.yml ps

          # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
          echo "æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
          if curl -f http://localhost:8000/api/healthz 2>/dev/null; then
            echo "âœ… åç«¯APIå¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ åç«¯APIå¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

          if curl -f http://localhost 2>/dev/null; then
            echo "âœ… å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âŒ å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
            exit 1
          fi

          echo "ğŸ‰ éƒ¨ç½²éªŒè¯å®Œæˆï¼"

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯åœ°å€: http://${{ secrets.SERVER_HOST }}"
          echo "ğŸ”§ åç«¯API: http://${{ secrets.SERVER_HOST }}:8000"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—å’ŒGitHub Actionsæ—¥å¿—"
        fi
