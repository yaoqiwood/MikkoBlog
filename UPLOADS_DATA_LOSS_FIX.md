# é™æ€èµ„æº (Uploads) æ•°æ®ä¸¢å¤±é—®é¢˜ä¿®å¤

## é—®é¢˜æè¿°

éƒ¨ç½²å®Œæˆåï¼Œç½‘ç«™ä¸Šçš„å›¾ç‰‡å…¨éƒ¨è¿”å› 404 é”™è¯¯ï¼š

```
GET https://www.mikkocat.top/uploads/images/20251017_140746_99a8c1c3.jpg 404 (Not Found)
```

## æ ¹æœ¬åŸå› 

**åœ¨éƒ¨ç½²è„šæœ¬ä¸­ä½¿ç”¨äº†é”™è¯¯çš„ `git clean` å‘½ä»¤ï¼Œå¯¼è‡´ç”¨æˆ·ä¸Šä¼ çš„æ•°æ®è¢«åˆ é™¤ï¼**

### é—®é¢˜ä»£ç 

```bash
# âŒ é”™è¯¯ï¼šä¼šåˆ é™¤æ‰€æœ‰æœªè¢« git è·Ÿè¸ªçš„æ–‡ä»¶
git clean -fd
```

è¿™ä¸ªå‘½ä»¤ä¼šåˆ é™¤ï¼š
- âœ— `backend/uploads/images/` ä¸­çš„æ‰€æœ‰å›¾ç‰‡
- âœ— `backend/uploads/music/` ä¸­çš„æ‰€æœ‰éŸ³ä¹æ–‡ä»¶
- âœ— æ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„æ•°æ®

### ä¸ºä»€ä¹ˆä¼šå½±å“ç”Ÿäº§ç¯å¢ƒ

Docker Compose ä½¿ç”¨äº†**ç»‘å®šæŒ‚è½½ (bind mount)**ï¼š

```yaml
# docker-compose.prod.yml
volumes:
  - ./backend/uploads:/app/uploads  # å®¿ä¸»æœºç›®å½• -> å®¹å™¨å†…ç›®å½•
```

è¿™æ„å‘³ç€ï¼š
1. å®¹å™¨å†…çš„ `/app/uploads` ç›´æ¥ä½¿ç”¨å®¿ä¸»æœºçš„ `./backend/uploads` ç›®å½•
2. å¦‚æœå®¿ä¸»æœºçš„ç›®å½•è¢«åˆ é™¤ï¼Œå®¹å™¨å†…ä¹Ÿæ— æ³•è®¿é—®
3. **æ¯æ¬¡éƒ¨ç½²æ—¶ `git clean -fd` éƒ½ä¼šåˆ é™¤è¿™ä¸ªç›®å½•ï¼**

## å½±å“èŒƒå›´

### å—å½±å“çš„æ–‡ä»¶

1. âŒ `github-deploy.sh` - GitHub Actions è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
2. âŒ `server-deploy.sh` - æœåŠ¡å™¨éƒ¨ç½²è„šæœ¬
3. âŒ `server-deploy-root.sh` - Root ç”¨æˆ·éƒ¨ç½²è„šæœ¬

### å—å½±å“çš„æ•°æ®

- æ‰€æœ‰ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡ï¼ˆåšå®¢æ–‡ç« é…å›¾ã€å¤´åƒç­‰ï¼‰
- æ‰€æœ‰ä¸Šä¼ çš„éŸ³ä¹æ–‡ä»¶
- å…¶ä»– uploads ç›®å½•ä¸­çš„æ–‡ä»¶

## ä¿®å¤æ–¹æ¡ˆ

### 1. ä¿®å¤éƒ¨ç½²è„šæœ¬

**æ­£ç¡®çš„åšæ³•ï¼šæ’é™¤ uploads ç›®å½•**

```bash
# âœ… æ­£ç¡®ï¼šæ¸…ç†æœªè·Ÿè¸ªçš„æ–‡ä»¶ï¼Œä½†ä¿ç•™ uploads ç›®å½•
git clean -fd -e backend/uploads -e uploads
```

**è¯´æ˜ï¼š**
- `-f` : forceï¼ˆå¼ºåˆ¶ï¼‰
- `-d` : åˆ é™¤ç›®å½•
- `-e backend/uploads` : æ’é™¤ backend/uploads ç›®å½•
- `-e uploads` : æ’é™¤ uploads ç›®å½•

### 2. æ¢å¤ä¸¢å¤±çš„æ•°æ®

å¦‚æœä½ æœ‰æ—§çš„éƒ¨ç½²è·¯å¾„ï¼ˆå¦‚ `/var/www/mikkoblog`ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨æ¢å¤è„šæœ¬ï¼š

```bash
# åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ
cd /opt/mikkoblog
chmod +x restore-uploads.sh
./restore-uploads.sh
```

è¿™ä¸ªè„šæœ¬ä¼šï¼š
1. ä»æ—§è·¯å¾„å¤åˆ¶ uploads ç›®å½•åˆ°æ–°è·¯å¾„
2. è®¾ç½®æ­£ç¡®çš„æ–‡ä»¶æƒé™
3. æ˜¾ç¤ºæ¢å¤çš„æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯

### 3. æ‰‹åŠ¨æ¢å¤æ­¥éª¤

å¦‚æœæ²¡æœ‰è‡ªåŠ¨æ¢å¤è„šæœ¬ï¼Œå¯ä»¥æ‰‹åŠ¨æ‰§è¡Œï¼š

```bash
# 1. æ£€æŸ¥æ—§è·¯å¾„æ˜¯å¦æœ‰æ•°æ®
ls -lah /var/www/mikkoblog/backend/uploads/images/

# 2. å¤åˆ¶æ•°æ®åˆ°æ–°è·¯å¾„
rsync -av /var/www/mikkoblog/backend/uploads/ /opt/mikkoblog/backend/uploads/

# 3. è®¾ç½®æƒé™
chmod -R 755 /opt/mikkoblog/backend/uploads

# 4. é‡å¯ Docker æœåŠ¡
cd /opt/mikkoblog
docker-compose -f docker-compose.prod.yml restart

# 5. éªŒè¯æ–‡ä»¶å¯è®¿é—®
curl -I https://www.mikkocat.top/uploads/images/20251017_140746_99a8c1c3.jpg
```

## é¢„é˜²æªæ–½

### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ git clean æ’é™¤ï¼ˆæ¨èï¼‰

å·²åœ¨ä¿®å¤ä¸­å®æ–½ï¼Œæ¯æ¬¡éƒ¨ç½²æ—¶ä¿ç•™ uploads ç›®å½•ã€‚

### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ Docker Named Volume

ä¿®æ”¹ `docker-compose.prod.yml`ï¼š

```yaml
services:
  backend:
    volumes:
      - uploads_data:/app/uploads  # ä½¿ç”¨å‘½åå·è€Œä¸æ˜¯ç»‘å®šæŒ‚è½½
      - ./backend/config:/app/config

volumes:
  db_data:
  uploads_data:  # æ–°å¢å‘½åå·
```

**ä¼˜ç‚¹ï¼š**
- æ•°æ®ç‹¬ç«‹äºä»£ç ç›®å½•
- ä¸ä¼šè¢« git clean å½±å“
- Docker è‡ªåŠ¨ç®¡ç†

**ç¼ºç‚¹ï¼š**
- æ•°æ®å¤‡ä»½éœ€è¦é¢å¤–æ­¥éª¤
- ä¸èƒ½ç›´æ¥åœ¨å®¿ä¸»æœºè®¿é—®æ–‡ä»¶

### æ–¹æ¡ˆ Cï¼šåˆ†ç¦»æ•°æ®ç›®å½•

å°† uploads ç›®å½•æ”¾åœ¨é¡¹ç›®ç›®å½•å¤–ï¼š

```yaml
services:
  backend:
    volumes:
      - /var/uploads:/app/uploads  # ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®ç›®å½•
```

## éªŒè¯ä¿®å¤

### 1. æ£€æŸ¥éƒ¨ç½²è„šæœ¬

```bash
# ç¡®è®¤åŒ…å« -e å‚æ•°
grep "git clean" github-deploy.sh
# åº”è¯¥çœ‹åˆ°ï¼šgit clean -fd -e backend/uploads -e uploads
```

### 2. æ£€æŸ¥æ–‡ä»¶å­˜åœ¨

```bash
# åœ¨æœåŠ¡å™¨ä¸Š
ls -lah /opt/mikkoblog/backend/uploads/images/
```

### 3. æµ‹è¯• API è®¿é—®

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8000/api/healthz

# æµ‹è¯•å›¾ç‰‡è®¿é—®ï¼ˆä»å®¹å™¨å†…ï¼‰
docker exec mikko_backend ls -lah /app/uploads/images/

# æµ‹è¯•å›¾ç‰‡è®¿é—®ï¼ˆé€šè¿‡ HTTPï¼‰
curl -I https://www.mikkocat.top/uploads/images/20251017_140746_99a8c1c3.jpg
```

## éƒ¨ç½²è·¯å¾„è¯´æ˜

### å½“å‰éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub Repository (yaoqiwood/MikkoBlog)   â”‚
â”‚  â†“ push to cicd-deploy branch              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub Actions (è‡ªåŠ¨è§¦å‘)                  â”‚
â”‚  - SSH è¿æ¥åˆ°æœåŠ¡å™¨                         â”‚
â”‚  - æ‰§è¡Œ github-deploy.sh                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æœåŠ¡å™¨: /opt/mikkoblog (æ–°éƒ¨ç½²è·¯å¾„)        â”‚
â”‚  - git pull æœ€æ–°ä»£ç                         â”‚
â”‚  - docker-compose up (é‡æ–°æ„å»ºå’Œå¯åŠ¨)       â”‚
â”‚  - volumes:                                 â”‚
â”‚    - ./backend/uploads:/app/uploads         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ—§éƒ¨ç½²è·¯å¾„

- `/var/www/mikkoblog` - ä¹‹å‰æ‰‹åŠ¨éƒ¨ç½²çš„è·¯å¾„ï¼ˆå¯èƒ½åŒ…å«æ—§çš„ uploads æ•°æ®ï¼‰

### ä¸ºä»€ä¹ˆæœ‰ä¸¤ä¸ªè·¯å¾„

1. **æ—§è·¯å¾„** (`/var/www/mikkoblog`)ï¼š
   - æ‰‹åŠ¨éƒ¨ç½²æ—¶åˆ›å»º
   - å¯èƒ½åŒ…å«ä¹‹å‰ä¸Šä¼ çš„æ‰€æœ‰æ•°æ®
   - ä»£ç å¯èƒ½å·²ç»è¿‡æ—¶

2. **æ–°è·¯å¾„** (`/opt/mikkoblog`)ï¼š
   - GitHub Actions è‡ªåŠ¨éƒ¨ç½²
   - åœ¨ `CICD_SETUP.md` ä¸­é…ç½®
   - ä»£ç å§‹ç»ˆä¿æŒæœ€æ–°

## å¤‡ä»½å»ºè®®

### å®šæœŸå¤‡ä»½ uploads ç›®å½•

åˆ›å»ºå®šæ—¶ä»»åŠ¡ï¼š

```bash
# æ·»åŠ åˆ° crontab
crontab -e

# æ¯å¤©å‡Œæ™¨ 3 ç‚¹å¤‡ä»½
0 3 * * * rsync -av /opt/mikkoblog/backend/uploads /backup/uploads-$(date +\%Y\%m\%d)
```

### å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
BACKUP_DIR="/backup/mikkoblog"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p "$BACKUP_DIR"
tar -czf "$BACKUP_DIR/uploads-$DATE.tar.gz" -C /opt/mikkoblog/backend uploads

# ä¿ç•™æœ€è¿‘ 7 å¤©çš„å¤‡ä»½
find "$BACKUP_DIR" -name "uploads-*.tar.gz" -mtime +7 -delete
```

## æäº¤è®°å½•

```bash
# æŸ¥çœ‹ä¿®å¤æäº¤
git log --oneline --grep="uploads"

# ä¿®å¤æäº¤åº”åŒ…å«ï¼š
# - æ¢å¤ git clean -fd -e backend/uploads -e uploads
# - æ·»åŠ æ¢å¤è„šæœ¬ restore-uploads.sh
# - æ·»åŠ æœ¬è¯´æ˜æ–‡æ¡£
```

## æ€»ç»“

- âŒ **é—®é¢˜**ï¼š`git clean -fd` åˆ é™¤äº†ç”¨æˆ·ä¸Šä¼ çš„æ‰€æœ‰æ–‡ä»¶
- âœ… **ä¿®å¤**ï¼šä½¿ç”¨ `git clean -fd -e backend/uploads -e uploads` æ’é™¤ uploads ç›®å½•
- ğŸ”„ **æ¢å¤**ï¼šä½¿ç”¨ `restore-uploads.sh` ä»æ—§è·¯å¾„æ¢å¤æ•°æ®
- ğŸ›¡ï¸ **é¢„é˜²**ï¼šå®šæœŸå¤‡ä»½ uploads ç›®å½•

**é‡è¦æé†’ï¼š** uploads ç›®å½•åŒ…å«ç”¨æˆ·æ•°æ®ï¼Œç»å¯¹ä¸èƒ½åœ¨éƒ¨ç½²æ—¶è¢«æ¸…é™¤ï¼

